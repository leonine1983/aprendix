<style>
  .historico-wrapper {
    background-color: #f8f9fa;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 0 8px rgba(0,0,0,0.05);
    margin-bottom: 2rem;
  }

  .historico-wrapper h2 {
    font-size: 1.8rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    color: #343a40;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 0 4px rgba(0,0,0,0.1);
  }

  thead {
    background-color: #007bff;
    color: white;
  }

  th, td {
    padding: 0.75rem 1rem;
    text-align: center;
    border: 1px solid #dee2e6;
    font-size: 0.95rem;
  }

  th[rowspan="2"] {
    background-color: #0056b3;
    font-weight: bold;
  }

  th[colspan="2"] {
    font-weight: 500;
    background-color: #007bff;
  }

  thead small {
    font-size: 0.8rem;
    color: #f1f1f1;
    font-weight: 400;
  }

  tbody tr:nth-child(even) {
    background-color: #f2f6fc;
  }

  tbody td:first-child {
    text-align: left;
    font-weight: 500;
    background-color: #f0f0f0;
  }

  .vertical-text {
  writing-mode: vertical-rl;
  transform: rotate(180deg); /* para deixar a leitura de baixo para cima */
  text-align: center;
  vertical-align: middle;
  white-space: nowrap;
  display: flex;
}
</style>
{% load meus_filtros %}

<div class="historico-wrapper">
  <h2>Histórico Escolar de {{ matricula.aluno.nome_completo }}</h2>

  <table>
    <thead>
      <tr>
        <th rowspan="2" colspan="2">Disciplina</th>
        {% for t in serie %}
          <th colspan="2">{{ t }}</th>
        {% endfor %}
      </tr>
      <tr>
        {% for t in serie %}
          <th><small>N</small></th>
          <th><small>CH</small></th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
  {% for grupo in disciplina|unique_objects:"campo_conhecimento" %}
    {% with grupo.campo_conhecimento as campo %}
      {% with disciplina|filter_campo_conhecimento:campo as disciplinas_do_campo %}
        {% for d in disciplinas_do_campo %}
          <tr>
            {% if forloop.first %}
              <td rowspan="{{ disciplinas_do_campo|length }}"  style="text-transform: uppercase; background-color: #f0f0f0;">
                <div class="vertical-text">
                  {{ campo }}
                </div>
              </td>
            {% endif %}
            <td style="text-align: left; ">{{ d }}</td>
            {% for t in serie %}
              {% with d|make_tuple:t as dt %}
                {% with historico|get_historico:dt as h %}
                  {% if h %}
                    <td>{{ h.media_final }}</td>
                    <td class="ch-cell" data-serie="{{ t.id }}">{{ h.grade.carga_horaria_anual }}</td>
                  {% else %}
                    <td contenteditable="true"></td>
                    <td contenteditable="true" class="ch-cell" data-serie="{{ t.id }}"></td>
                  {% endif %}
                {% endwith %}
              {% endwith %}
            {% endfor %}
          </tr>
        {% endfor %}
      {% endwith %}
    {% endwith %}
  {% endfor %}

  <tr>
    <td colspan="2"><strong>Carga Horária Total</strong></td>
    {% for t in serie %}
      <td colspan="2" class="total-ch" data-serie="{{ t.id }}"></td>
    {% endfor %}
  </tr>
</tbody>

  </table>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    function atualizarTotais() {
      const totalCells = document.querySelectorAll('.total-ch');
      totalCells.forEach(totalCell => {
        const serieId = totalCell.getAttribute('data-serie');
        const chCells = document.querySelectorAll(`.ch-cell[data-serie="${serieId}"]`);
        let soma = 0;

        chCells.forEach(cell => {
          const texto = cell.textContent.trim().replace(',', '.'); // aceita vírgula ou ponto
          const valor = parseFloat(texto);
          if (!isNaN(valor)) {
            soma += valor;
          }
        });

        totalCell.textContent = soma.toFixed(0); // sem casas decimais
      });
    }

    // Recalcular totais quando o conteúdo editável for alterado
    const chEditaveis = document.querySelectorAll('.ch-cell[contenteditable="true"]');
    chEditaveis.forEach(cell => {
      cell.addEventListener('input', atualizarTotais);
      cell.addEventListener('blur', atualizarTotais);
    });

    atualizarTotais(); // roda ao carregar
  });
</script>
